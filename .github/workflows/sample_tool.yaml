name: NCAI Remediation Tool Trigger

on:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  handle-issue-comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request != null
    steps:
      - name: Call external API with issue comment data
        env:
          API_URL: ${{ vars.NCAI_SVRT_TRIGGER_URL }}
        run: |
          echo "Sending PR URL to external API for issue comment..."
          
          # Construct PR URL from context
          PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.issue.number }}"
          
          PAYLOAD=$(jq -n \
            --arg pr_url "$PR_URL" \
            --arg scope "issue_comment" \
            '{
              pr_url: $pr_url,
              scope: $scope
            }')
          
          echo "Payload to send (issue comment):"
          echo "$PAYLOAD" | jq .
          echo "Sending data to $API_URL"
          
          SUCCESS=false
          for i in {1..3}; do
            echo "Attempt $i of 3..."
            
            response=$(curl -s -o response.txt -w "%{http_code}" -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")
            
            echo "HTTP Status: $response"
            
            if [ "$response" -ge 200 ] && [ "$response" -lt 300 ]; then
              echo "✅ Successfully sent remediation start for issue comment."
              if [ -f response.txt ]; then
                echo "Response:"
                cat response.txt
              fi
              SUCCESS=true
              break
            else
              echo "❌ Attempt $i failed (status $response)"
              if [ -f response.txt ]; then
                echo "Error response:"
                cat response.txt
              fi
              if [ $i -lt 3 ]; then
                echo "Retrying in 5 seconds..."
                sleep 5
              fi
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "❌ All attempts failed"
            exit 1
          fi

  handle-review-comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_review_comment'
    steps:
      - name: Call external API with review comment data
        env:
          API_URL: ${{ vars.NCAI_SVRT_TRIGGER_URL }}
        run: |
          echo "Sending PR URL to external API for review comment..."
          
          # Construct PR URL from context
          PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
          
          PAYLOAD=$(jq -n \
            --arg pr_url "$PR_URL" \
            --arg scope "review_comment" \
            '{
              pr_url: $pr_url,
              scope: $scope
            }')
          
          echo "Payload to send (review comment):"
          echo "$PAYLOAD" | jq .
          echo "Sending data to $API_URL"
          
          SUCCESS=false
          for i in {1..3}; do
            echo "Attempt $i of 3..."
            
            response=$(curl -s -o response.txt -w "%{http_code}" -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")
            
            echo "HTTP Status: $response"
            
            if [ "$response" -ge 200 ] && [ "$response" -lt 300 ]; then
              echo "✅ Successfully sent remediation start for review comment."
              if [ -f response.txt ]; then
                echo "Response:"
                cat response.txt
              fi
              SUCCESS=true
              break
            else
              echo "❌ Attempt $i failed (status $response)"
              if [ -f response.txt ]; then
                echo "Error response:"
                cat response.txt
              fi
              if [ $i -lt 3 ]; then
                echo "Retrying in 5 seconds..."
                sleep 5
              fi
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "❌ All attempts failed"
            exit 1
          fi
