name: Trigger Remediation After Checkmarx Comment

on:
  issue_comment:
    types: [created, edited]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  after-checkmarx:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request != null
    steps:
      - name: Check if comment is from Checkmarx bot and matches expected format
        id: check-comment
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          echo "Comment author: $COMMENT_AUTHOR"
          echo "Comment body: $COMMENT_BODY"

          # Only proceed if author is Checkmarx bot AND body matches the pattern
          if [[ "$COMMENT_AUTHOR" == "riyanshguptanewscorp" ]] && \
             echo "$COMMENT_BODY" | grep -q -E 'Checkmarx One[[:space:]]*–[[:space:]]*Scan Summary'; then
            echo "✅ Valid Checkmarx comment by $COMMENT_AUTHOR"
            echo "match=true" >> "$GITHUB_OUTPUT"
          else
            echo "⛔ Not a valid Checkmarx comment. Skipping."
            echo "match=false" >> "$GITHUB_OUTPUT"
          fi
        shell: bash

      - name: Stop if comment is not a valid Checkmarx comment
        if: steps.check-comment.outputs.match != 'true'
        run: |
          echo "Comment did not meet Checkmarx requirements. Exiting."
          exit 0

      - name: Call external API with remediation data
        env:
          GITHUB_TOKEN_SECRET: ${{ secrets.NCAI_SVRT_TOKEN }}
          API_URL: ${{ vars.NCAI_SVRT_TRIGGER_URL }}
        run: |
          echo "Fetching PR data from GitHub..."
          PR_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
                        -H "Authorization: Bearer $GITHUB_TOKEN_SECRET" \
                        "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")

          GITHUB_URL=$(echo "$PR_JSON" | jq -r '.head.repo.html_url')
          BASE_BRANCH=$(echo "$PR_JSON" | jq -r '.base.ref')
          FEATURE_BRANCH=$(echo "$PR_JSON" | jq -r '.head.ref')
          REPO_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.name')
          OWNER_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.owner.login')
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          # Encode the token as base64(username:token)
          ENCODED_AUTH=$(echo -n "x-access-token:$GITHUB_TOKEN_SECRET" | base64)


          PAYLOAD=$(jq -n \
            --arg url "$GITHUB_URL" \
            --arg default_branch "$BASE_BRANCH" \
            --arg feature_branch "$FEATURE_BRANCH" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg repo "$REPO_NAME" \
            --arg owner "$OWNER_NAME" \
            '{
              url: $url,
              default_branch: $default_branch,
              feature_branch: $feature_branch,
              issue_number: $issue_number,
              repo: $repo,
              owner: $owner
            }')

          echo "Sending data to $API_URL"
          for i in {1..3}; do
            response=$(curl -s -o response.txt -w "%{http_code}" -X POST "$API_URL" \
                      -H "Content-Type: application/json" \
                      -H "Authorization: Bearer $ENCODED_AUTH" \
                      -d "$PAYLOAD")
            if [ "$response" -ge 200 ] && [ "$response" -lt 300 ]; then
              echo "✅ Successfully sent remediation start."
              cat response.txt
              break
            else
              echo "❌ Attempt $i failed (status $response). Retrying in 5 seconds..."
              sleep 5
            fi
          done
