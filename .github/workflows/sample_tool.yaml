on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  after-checkmarx:
    runs-on: ubuntu-latest
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, 'Checkmarx One - Scan Summary & Details -')
    steps:
      - name: Debug Info
        run: |
          echo "Comment detected on PR #${{ github.event.issue.number }}"
          echo "Comment contains Checkmarx completion message"

      - name: Generate UUID
        id: uuid
        run: echo "uuid=$(uuidgen)" >> "$GITHUB_OUTPUT"

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.NCAI_SVRT_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: | 
            üõ†Ô∏è **Vulnerability remediation started** for this PR!
            üîó **Follow this URL for detailed analysis**: [View Report](https://your-link-here.com/report/${{ steps.uuid.outputs.uuid }})

      - name: Call external API with remediation data
        env:
          GITHUB_TOKEN_SECRET: ${{ secrets.NCAI_SVRT_TOKEN }}
          API_URL: ${{ secrets.NCAI_SVRT_TRIGGER_URL }}
          UUID: ${{ steps.uuid.outputs.uuid }}
        run: |
          echo "Fetching PR data from GitHub..."
          PR_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
                        -H "Authorization: Bearer $GITHUB_TOKEN_SECRET" \
                        "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")

          echo "$PR_JSON"
          GITHUB_URL=$(echo "$PR_JSON" | jq -r '.head.repo.html_url')
          BASE_BRANCH=$(echo "$PR_JSON" | jq -r '.base.ref')
          FEATURE_BRANCH=$(echo "$PR_JSON" | jq -r '.head.ref')
          REPO_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.name')
          OWNER_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.owner.login')
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          PAYLOAD=$(jq -n \
            --arg task_id "$UUID" \
            --arg url "$GITHUB_URL" \
            --arg default_branch "$BASE_BRANCH" \
            --arg feature_branch "$FEATURE_BRANCH" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg repo "$REPO_NAME" \
            --arg owner "$OWNER_NAME" \
            '{
              url: $url,
              task_id: $task_id,
              default_branch: $default_branch,
              feature_branch: $feature_branch,
              issue_number: $issue_number,
              repo: $repo,
              owner: $owner
            }')

          echo "Payload to be sent:"
          echo "$PAYLOAD"

          echo "Sending data to $API_URL/${UUID}"
          curl -X POST "$API_URL/${UUID}" \
               -H "Content-Type: application/json" \
               -H "Authorization: Bearer $GITHUB_TOKEN_SECRET" \
               -d "$PAYLOAD"
