name: Trigger Remediation After Checkmarx Comment

on:
  issue_comment:
    types: [created, edited]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  after-checkmarx:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request != null

    steps:
      - name: Check if comment is from Checkmarx and matches pattern
        id: check-comment
        run: |
          COMMENT="${{ github.event.comment.body }}"
          AUTHOR="${{ github.event.comment.user.login }}"
          echo "Triggering comment: $COMMENT"
          echo "Author: $AUTHOR"

          IS_MATCH=false

          if echo "$COMMENT" | grep -q -E 'Checkmarx One[[:space:]]*–[[:space:]]*Scan Summary'; then
            if [ "$AUTHOR" = "riyanshguptanewscorp" ]; then
              IS_MATCH=true
            fi
          fi

          echo "match=$IS_MATCH" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Skip if not Checkmarx pattern or not expected author
        if: steps.check-comment.outputs.match != 'true'
        run: |
          echo "Comment did not match both Checkmarx pattern and author. Skipping."

      - name: Call external API with remediation data
        if: steps.check-comment.outputs.match == 'true'
        env:
          GITHUB_TOKEN_SECRET: ${{ secrets.NCAI_SVRT_TOKEN }}
          API_URL: ${{ vars.NCAI_SVRT_TRIGGER_URL }}
        run: |
          echo "Fetching PR data from GitHub..."
          PR_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
                        -H "Authorization: Bearer $GITHUB_TOKEN_SECRET" \
                        "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")

          GITHUB_URL=$(echo "$PR_JSON" | jq -r '.head.repo.html_url')
          BASE_BRANCH=$(echo "$PR_JSON" | jq -r '.base.ref')
          FEATURE_BRANCH=$(echo "$PR_JSON" | jq -r '.head.ref')
          REPO_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.name')
          OWNER_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.owner.login')
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          # Encode the token as base64(username:token)
          ENCODED_AUTH=$(echo -n "x-access-token:$GITHUB_TOKEN_SECRET" | base64)
          
          PAYLOAD=$(jq -n \
            --arg url "$GITHUB_URL" \
            --arg default_branch "$BASE_BRANCH" \
            --arg feature_branch "$FEATURE_BRANCH" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg repo "$REPO_NAME" \
            --arg owner "$OWNER_NAME" \
            '{
              url: $url,
              default_branch: $default_branch,
              feature_branch: $feature_branch,
              issue_number: $issue_number,
              repo: $repo,
              owner: $owner
            }')

          echo "Sending data to $API_URL"
          for i in {1..3}; do
            response=$(curl -s -o response.txt -w "%{http_code}" -X POST "$API_URL" \
                      -H "Content-Type: application/json" \
                      -H "Authorization: Bearer $ENCODED_AUTH" \
                      -d "$PAYLOAD")
            if [ "$response" -ge 200 ] && [ "$response" -lt 300 ]; then
              echo "✅ Successfully sent remediation start."
              cat response.txt
              break
            else
              echo "❌ Attempt $i failed (status $response). Retrying in 5 seconds..."
              sleep 5
            fi
          done
